<!--detail.wxml-->
<navigation-bar title="商品详情" back="{{true}}" color="black" background="#FFF"></navigation-bar>


<!-- 顶部筛选切换栏 -->
<view class="filter-bar" wx:if="{{product}}">
  <button class="filter-btn filter-btn-all {{filterType==='all' ? 'active' : ''}}" bindtap="onFilterTypeChange" data-type="all">全部</button>
  
  <!-- 品牌筛选，仅在有品牌数据时显示 -->
  <picker wx:if="{{brandList.length > 0}}" mode="selector" range="{{brandList}}" value="{{brandIndex}}" bindchange="onBrandPickerChange">
    <view class="filter-btn filter-btn-brand {{filterType==='brand' ? 'active' : ''}}" bindtap="onFilterTypeChange" data-type="brand">
      <text wx:if="{{filterType==='brand' && selectedBrand}}">{{selectedBrand}}</text>
      <text wx:else>品牌</text>
    </view>
  </picker>
  
  <!-- 店铺筛选，仅在有店铺数据时显示 -->
  <picker wx:if="{{locationList.length > 0}}" mode="selector" range="{{locationList}}" value="{{locationIndex}}" bindchange="onLocationPickerChange">
    <view class="filter-btn filter-btn-location {{filterType==='location' ? 'active' : ''}}" bindtap="onFilterTypeChange" data-type="location">
      <text wx:if="{{filterType==='location' && selectedLocation}}">{{selectedLocation}}</text>
      <text wx:else>店铺</text>
    </view>
  </picker>
</view>

<view class="container" wx:if="{{product}}">

  <!-- 价格趋势折线图（canvas重绘） -->
  <view class="chart-card" wx:if="{{priceHistory.length > 1}}">
    <view class="chart-header">
      <text class="chart-title">价格趋势</text>
      <text class="chart-subtitle">{{priceHistory.length}}次记录</text>
    </view>
    <view class="chart-container" style="height: 140px; position: relative;">
      <canvas canvas-id="trendCanvas" id="trendCanvas" style="width: 300px; height: 140px; background: #F2F2F7; border-radius: 8px;"></canvas>
      <block wx:for="{{priceHistory}}" wx:key="id">
        <cover-view
          style="position: absolute; width: 24px; height: 24px; left: {{item.x-12}}px; top: {{item.y-12}}px; z-index: 10; background: transparent;"
          data-id="{{item.id}}"
          bindtap="onTrendPointTap"
        ></cover-view>
      </block>
    </view>
  </view>
  
  <!-- 单个数据提示卡片 -->
  <view class="single-data-tip" wx:elif="{{priceHistory.length == 1}}">
    <view class="tip-icon">
      <text>!</text>
    </view>
    <view class="tip-text">
      <text>添加更多价格记录，即可查看价格趋势和历史记录</text>
    </view>
  </view>

  <!-- 价格历史列表 -->
  <view class="history-card" wx:if="{{priceHistory.length > 1}}">
    <view class="history-header">
      <text class="history-title">价格记录</text>
      <text class="history-count">共 {{priceHistoryCount}} 条</text>
    </view>
    
    <view 
      wx:for="{{priceHistory}}" 
      wx:key="id"
      class="history-item-container"
    >
      <view 
        class="history-item {{item.isCurrent ? 'current' : ''}} {{item.swiping ? 'swiping' : ''}}"
        data-id="{{item.id}}"
        data-index="{{index}}"
        bindtouchstart="onTouchStart"
        bindtouchmove="onTouchMove"
        bindtouchend="onTouchEnd"
        bindtap="onHistoryItemTap"
      >
        <view class="history-info">
          <view class="history-date">{{item.date}}</view>
          <view class="history-location">{{item.location}}</view>
        </view>
        <view class="history-price {{item.isMin ? 'savings-price' : ''}}">
          <text>{{item.currencySymbol || '¥'}}</text>{{item.currentPrice}}
        </view>
        <view wx:if="{{item.isCurrent}}" class="current-indicator">当前</view>
      </view>
      <view 
        class="edit-btn" 
        data-id="{{item.id}}" 
        catchtap="editHistoryItem"
      >编辑</view>
      <view 
        class="delete-btn" 
        data-id="{{item.id}}" 
        catchtap="deleteProduct"
      >删除</view>
    </view>
  </view>

  <!-- 操作按钮 -->
  <!-- <view class="action-section"> -->
  <!--   <button class="action-btn btn-edit" bindtap="editProduct">编辑</button> -->
  <!--   <button class="action-btn btn-delete" bindtap="deleteProduct">删除</button> -->
  <!-- </view> -->

  <!-- 添加按钮 -->
  <view class="add-button-container">
    <button class="add-button" bindtap="goToAddPage">添加记录</button>
  </view>
</view>

<!-- 加载状态 -->
<view class="loading" wx:else>
  <view class="loading-text">加载中...</view>
</view>
